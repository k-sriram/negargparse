#!/bin/bash
set -o nounset
set -o errexit

root=$(git rev-parse --show-toplevel)
toml="$root/pyproject.toml"

pkg=$(grep -Po "(?<=^name = \").*(?=\"$)" $toml)

src="$root/$pkg"

pkg_version=$(grep -Po "(?<=^version = \").*(?=\"$)" $toml)
echo "Package $pkg:$pkg_version"
echo "Module versions:-"
modverwfile=$(grep -Pro "(?<=^__version__ = \").*(?=\"$)" $src)

for ver in $modverwfile
do
    echo "  ${ver#"$src/"}"
done

module_versions=$(grep -Phro "(?<=^__version__ = \").*(?=\"$)" $src)
for ver in $module_versions
do
    if [[ $ver != $pkg_version ]]
    then
        echo -e "\033[1;31mERROR: \033[0;31mPackage and module version mismatch.\033[0m $pkg_version != $ver"
        exit 1
    fi
done
